import numpy as np
from utils.coord_transform import wgs84_to_gcj02
from shapely.wkt import loads
from shapely.geometry import Polygon, Point


def generate_masked_heat_map(frames):
    mask = get_mask(frames)
    filtered = frames * mask
    return filtered


def get_mask(frames):
    study_area_wgs84_polygon = loads(
        'POLYGON ((116.490977413161 39.865813884785,116.491583429247 39.8654021046241,116.491567890373 39.8647727802273,116.491447464099 39.8645435818359,116.491233804582 39.8644736569029,116.491086185279 39.8644658874659,116.485231914501 39.8644930804954,116.485457228174 39.8648543593158,116.485395072678 39.8649942091817,116.485262992249 39.8650990965812,116.485266876968 39.8652544853211,116.485426150426 39.8653943351871,116.485398957397 39.8654759142756,116.48551938367 39.865611879423,116.485966126298 39.8657711528815,116.485938933268 39.865650726608,116.486074898416 39.865627418297,116.486137053912 39.8657789223185,116.486494448013 39.8657556140075,116.486743069997 39.8658954638734,116.487290815306 39.8655613780826,116.487547206727 39.865658496045,116.487399587424 39.8657556140075,116.487329662491 39.8659886971174,116.487422895735 39.8662295496643,116.487640439971 39.8664315550263,116.487908485547 39.8664820563668,116.488269764367 39.8668083727207,116.488479539166 39.8667772949727,116.488592196003 39.8669404531496,116.488355228174 39.8671113807636,116.488281418523 39.8670414558306,116.488207608871 39.8670647641416,116.488246456056 39.867177420978,116.488180415842 39.867192959852,116.488160992249 39.8673133861255,116.487970641043 39.8671735362595,116.487896831391 39.8670492252676,116.488087182598 39.8669637614606,116.487955102169 39.8667267936322,116.487718134341 39.8667423325062,116.48761713166 39.8669831850531,116.487469512357 39.8669482225866,116.487380163831 39.8670259169566,116.487255852839 39.8668977212461,116.48720146678 39.8669132601201,116.486913997611 39.8672240376,116.486711992249 39.867262884785,116.486560488228 39.8675736622649,116.486241941311 39.8684283003347,116.487854099488 39.8687118847851,116.490146083402 39.8685293030156,116.490363627638 39.8687546166886,116.491358115574 39.8686069973856,116.492628418523 39.8676474719164,116.492640072678 39.8668627587796,116.492340949354 39.8665869437662,116.491066761686 39.8663266676268,116.490957989568 39.8662373191013,116.490895834073 39.8660780456429,116.490923027102 39.8659071180289,116.490973528442 39.865821654222,116.490977413161 39.865813884785))')
    x, y = study_area_wgs84_polygon.exterior.xy
    study_area_gcj02 = []
    for i in range(len(x)):
        study_area_gcj02.append(wgs84_to_gcj02(x[i], y[i]))
    study_area_gcj02_polygon = Polygon(study_area_gcj02)
    _, H, W = frames.shape
    mask = generate_region_mask(H, W, study_area_gcj02_polygon)
    return mask


def generate_region_mask(H, W, polygon):
    mask = np.zeros((H, W))
    for i in range(H):
        for j in range(W):
            lat, lng = revert_transform(j, i, -53, 26, 39.86807342116762, 116.49434030056)
            pt = Point(lng, lat)
            if polygon.contains(pt):
                mask[i, j] = 1
    return mask


def revert_transform(matrix_x, matrix_y, x_min, y_max, center_lat, center_lng):
    ori_x = matrix_x + x_min
    ori_y = y_max - matrix_y
    return decode_lat(center_lat, ori_y), decode_lng(center_lng, ori_x)


def decode_lat(center_lat, y):
    # lat near 11.1m
    return (1e4 * center_lat + y) / 1e4


def decode_lng(center_lng, x):
    # lng near 8.5m
    return (1e4 * center_lng + x) / 1e4
